from datetime import date, timedelta

def quarter_start(d: date) -> date:
    month = ((d.month - 1) // 3) * 3 + 1
    return date(d.year, month, 1)

def quarter_end(d: date) -> date:
    qs = quarter_start(d)
    if qs.month == 10:
        return date(d.year, 12, 31)
    else:
        return date(d.year, qs.month + 3, 1) - timedelta(days=1)

def split_by_quarter(start_date: date, end_date: date):
    """
    Split [start_date, end_date] into calendar-quarter intervals.
    """
    if start_date > end_date:
        raise ValueError("start_date must be <= end_date")

    intervals = []
    current_start = start_date

    while True:
        qe = quarter_end(current_start)
        current_end = min(qe, end_date)

        intervals.append((current_start, current_end))

        if current_end == end_date:
            break

        current_start = current_end + timedelta(days=1)

    return intervalsfrom datetime import date

def split_by_year(start_date: date, end_date: date):
    """
    Split [start_date, end_date] into year-bounded intervals.
    First interval starts at start_date.
    Last interval ends at end_date.
    All middle intervals align to full calendar years.
    """
    if start_date > end_date:
        raise ValueError("start_date must be <= end_date")

    intervals = []

    current_start = start_date

    while current_start.year < end_date.year:
        year_end = date(current_start.year, 12, 31)
        intervals.append((current_start, year_end))
        current_start = date(current_start.year + 1, 1, 1)

    # final interval
    intervals.append((current_start, end_date))

    return intervals

import numpy as np

cols = ["Val1", "Val2", "Val3", "Val4"]

percentiles = [10, 25, 50, 75, 90]

stats = {}
latest = df.iloc[-1]

for c in cols:
    stats[c] = np.percentile(df[c].dropna(), percentiles)

import matplotlib.pyplot as plt

fig, ax = plt.subplots(figsize=(8, 5))

box_data = []
for c in cols:
    p10, p25, p50, p75, p90 = stats[c]
    box_data.append({
        "label": c,
        "whislo": p10,   # 10th percentile
        "q1": p25,       # 25th
        "med": p50,      # 50th (median)
        "q3": p75,       # 75th
        "whishi": p90,   # 90th percentile
        "fliers": []
    })

ax.bxp(box_data, showfliers=False)

# Plot latest values
x = range(1, len(cols) + 1)
ax.scatter(x, latest[cols], zorder=3, marker="D", label="Latest")

ax.set_title("Distribution with Percentiles & Latest Value")
ax.legend()
ax.grid(axis="y", alpha=0.3)

plt.tight_layout()
plt.show()



import pandas as pd

window = 252  # ~1Y trading days

roll_p10 = df["Val1"].rolling(window).quantile(0.10)
roll_p25 = df["Val1"].rolling(window).quantile(0.25)
roll_p50 = df["Val1"].rolling(window).quantile(0.50)
roll_p75 = df["Val1"].rolling(window).quantile(0.75)
roll_p90 = df["Val1"].rolling(window).quantile(0.90)

import plotly.graph_objects as go

fig = go.Figure()

# --- Val1 historical line ---
fig.add_trace(
    go.Scatter(
        x=df.index,
        y=df["Val1"],
        mode="lines",
        name="Val1",
        line=dict(width=2),
        hovertemplate="Date: %{x}<br>Val1: %{y:.4f}<extra></extra>",
    )
)

# --- 10–90 percentile band ---
fig.add_trace(
    go.Scatter(
        x=df.index,
        y=roll_p10,
        line=dict(width=0),
        showlegend=False,
        hoverinfo="skip",
    )
)

fig.add_trace(
    go.Scatter(
        x=df.index,
        y=roll_p90,
        fill="tonexty",
        name="10–90% (1Y rolling)",
        fillcolor="rgba(0, 100, 200, 0.15)",
        line=dict(width=0),
        hoverinfo="skip",
    )
)

# --- 25–75 percentile band ---
fig.add_trace(
    go.Scatter(
        x=df.index,
        y=roll_p25,
        line=dict(width=0),
        showlegend=False,
        hoverinfo="skip",
    )
)

fig.add_trace(
    go.Scatter(
        x=df.index,
        y=roll_p75,
        fill="tonexty",
        name="25–75% (1Y rolling)",
        fillcolor="rgba(0, 100, 200, 0.30)",
        line=dict(width=0),
        hoverinfo="skip",
    )
)

# --- Rolling median ---
fig.add_trace(
    go.Scatter(
        x=df.index,
        y=roll_p50,
        mode="lines",
        name="Rolling Median (50%)",
        line=dict(dash="dash", width=2),
        hovertemplate="Date: %{x}<br>Median: %{y:.4f}<extra></extra>",
    )
)

fig.update_layout(
    title="Val1 with 1Y Rolling Percentile Bands",
    yaxis_title="Value",
    hovermode="x unified",

    xaxis=dict(
        showgrid=True,
        gridcolor="lightgrey",
        gridwidth=0.5,
        tickformat="%Y-%m",
        dtick="M1",              # one grid per month
        ticklabelmode="period",
        rangeslider=dict(visible=True),
    ),

    yaxis=dict(
        showgrid=True,
        gridcolor="rgba(200,200,200,0.4)",
    ),

    legend=dict(
        orientation="h",
        yanchor="bottom",
        y=1.02,
        xanchor="right",
        x=1,
    ),

    template="plotly_white",
    height=600,
)

fig.show()

import pandas as pd
import matplotlib.pyplot as plt

window = 252  # ~1 year trading days

roll_p10 = df["Val1"].rolling(window).quantile(0.10)
roll_p25 = df["Val1"].rolling(window).quantile(0.25)
roll_p50 = df["Val1"].rolling(window).quantile(0.50)
roll_p75 = df["Val1"].rolling(window).quantile(0.75)
roll_p90 = df["Val1"].rolling(window).quantile(0.90)


fig, ax = plt.subplots(figsize=(12, 6))

# Main series
ax.plot(df.index, df["Val1"], label="Val1", linewidth=1.5)

# Shaded percentile bands
ax.fill_between(df.index, roll_p10, roll_p90, alpha=0.15, label="10–90% range")
ax.fill_between(df.index, roll_p25, roll_p75, alpha=0.25, label="25–75% range")

# Median
ax.plot(df.index, roll_p50, linestyle="--", linewidth=1.5, label="Rolling Median (50%)")

# Formatting
ax.set_title("Val1 with 1Y Rolling Percentile Bands")
ax.set_ylabel("Value")
ax.legend()


# Set monthly ticks
months = pd.date_range(
    start=df.index.min().normalize(),
    end=df.index.max().normalize(),
    freq="MS"
)

ax.set_xticks(months)

# Light grey vertical gridlines
ax.grid(axis="x", color="lightgrey", linestyle="-", linewidth=0.5, alpha=0.6)
ax.grid(axis="y", alpha=0.3)

# Improve label readability
fig.autofmt_xdate()

plt.tight_layout()
plt.show()


import numpy as np
import pandas as pd
import plotly.graph_objects as go
from scipy.stats import percentileofscore

# =========================
# CONFIG
# =========================
COLS = ["Val1", "Val2", "Val3", "Val4"]
ROLLING_DAYS = 252          # 1Y rolling window
TRAIL_LENGTH = 20           # days for fade-in/out
PCTS = [10, 25, 50, 75, 90]

df = df.sort_index()

# =========================
# PRECOMPUTE ROLLING STATS
# =========================
rolling_values = {
    c: df[c].rolling(ROLLING_DAYS, min_periods=ROLLING_DAYS)
    for c in COLS
}

# =========================
# BUILD ANIMATION FRAMES
# =========================
frames = []
x_pos = list(range(len(COLS)))
valid_dates = df.index[ROLLING_DAYS - 1 :]

for t_idx, date in enumerate(valid_dates):
    frame_data = []

    for i, c in enumerate(COLS):
        window = rolling_values[c].get_window(date)
        values = window.dropna()

        p10, p25, p50, p75, p90 = np.percentile(values, PCTS)
        val = df.loc[date, c]

        # Percentile rank
        rank = percentileofscore(values, val)

        # Color logic
        color = "green" if val >= p50 else "red"

        # --- BOX (25–75)
        frame_data.append(go.Scatter(
            x=[i, i, i, i, i],
            y=[p25, p75, p75, p25, p25],
            fill="toself",
            fillcolor="rgba(70,130,180,0.35)",
            line=dict(color="rgba(70,130,180,1)"),
            hoverinfo="skip",
            showlegend=False
        ))

        # --- MEDIAN
        frame_data.append(go.Scatter(
            x=[i - 0.25, i + 0.25],
            y=[p50, p50],
            mode="lines",
            line=dict(color="black", width=2),
            showlegend=False
        ))

        # --- WHISKERS (10–90)
        frame_data.append(go.Scatter(
            x=[i, i],
            y=[p10, p90],
            mode="lines",
            line=dict(color="black"),
            showlegend=False
        ))

        # --- FADE TRAIL
        trail_dates = valid_dates[max(0, t_idx - TRAIL_LENGTH) : t_idx]
        trail_vals = df.loc[trail_dates, c]

        alphas = np.linspace(0.1, 0.6, len(trail_vals))

        frame_data.append(go.Scatter(
            x=[i] * len(trail_vals),
            y=trail_vals,
            mode="markers",
            marker=dict(
                size=6,
                color=[f"rgba(128,128,128,{a})" for a in alphas]
            ),
            hoverinfo="skip",
            showlegend=False
        ))

        # --- CURRENT VALUE
        frame_data.append(go.Scatter(
            x=[i],
            y=[val],
            mode="markers+text",
            marker=dict(
                size=13,
                color=color,
                symbol="diamond"
            ),
            text=[f"{rank:.0f}th %"],
            textposition="top center",
            name="Value" if i == 0 else None,
            hovertemplate=(
                f"<b>{c}</b><br>"
                "Value: %{y:.2f}<br>"
                f"Rank: {rank:.1f}th pct<br>"
                f"Median: {p50:.2f}<extra></extra>"
            )
        ))

    frames.append(go.Frame(name=str(date.date()), data=frame_data))

# =========================
# INITIAL FIGURE
# =========================
fig = go.Figure(
    data=frames[0].data,
    frames=frames
)

# =========================
# LAYOUT + CONTROLS
# =========================
fig.update_layout(
    title="Rolling 1Y Percentile Box (Animated with Rank & Fade)",
    xaxis=dict(
        tickmode="array",
        tickvals=x_pos,
        ticktext=COLS
    ),
    yaxis_title="Value",
    template="plotly_white",
    hovermode="closest",

    updatemenus=[{
        "type": "buttons",
        "showactive": False,
        "buttons": [
            {
                "label": "▶ Play",
                "method": "animate",
                "args": [
                    None,
                    {
                        "frame": {"duration": 120, "redraw": True},
                        "fromcurrent": True
                    }
                ]
            },
            {
                "label": "⏸ Pause",
                "method": "animate",
                "args": [
                    [None],
                    {"frame": {"duration": 0}, "mode": "immediate"}
                ]
            }
        ]
    }],

    sliders=[{
        "steps": [
            {
                "method": "animate",
                "args": [[f.name], {"mode": "immediate"}],
                "label": f.name
            }
            for f in frames
        ],
        "currentvalue": {"prefix": "Date: "}
    }]
)

fig.show()


